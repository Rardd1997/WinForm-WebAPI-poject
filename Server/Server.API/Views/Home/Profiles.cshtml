
@{
    ViewBag.Title = "Profiles";
}

<h2>Profiles</h2>
<div id="TableBlock"></div>
<div id="EditBlock">
    <p>Edit user</p>
    <table>
        <tr><td><input type="hidden" id="EditId" /></td><td></td></tr>
        <tr><td><label>First name: </label></td><td><input type="text" name="EditFirstName" /></td></tr>
        <tr><td><label>Last name: </label></td><td><input type="text" name="EditLastName" /></td></tr>
        <tr><td><label>Password: </label></td><td><input type="text" name="EditPassword" /></td></tr>
        <tr><td><label>Status: </label></td><td><input type="number" name="EditStatus" /></td></tr>
        <tr><td><label>User level: </label></td><td><input type="number" name="EditLevel" /></td></tr>
        <tr><td><label>Last login: </label></td><td><input type="datetime" name="EditLastLogin" /></td></tr>
        <tr><td><label>Last update: </label></td><td><input type="datetime" name="EditLastUpdate" /></td></tr>
        <tr><td><label>Email: </label></td><td><input type="text" name="EditEmail" /></td></tr>
    </table>
    <button id="EditProfile">Сохранить</button>
</div>
<div id="AddBlock">
    <p>Add user</p>
    <table>
        <tr><td><label>First name: </label></td><td><input type="text" name="AddFirstName" /></td></tr>
        <tr><td><label>Last name: </label></td><td><input type="text" name="AddLastName" /></td></tr>
        <tr><td><label>Password: </label></td><td><input type="text" name="AddPassword" /></td></tr>
        <tr><td><label>Status: </label></td><td><input type="number" name="AddStatus" /></td></tr>
        <tr><td><label>User level: </label></td><td><input type="number" name="AddLevel" /></td></tr>
        <tr><td><label>Last login: </label></td><td><input type="datetime" name="AddLastLogin" /></td></tr>
        <tr><td><label>Last update: </label></td><td><input type="datetime" name="AddLastUpdate" /></td></tr>
        <tr><td><label>Email: </label></td><td><input type="text" name="AddEmail" /></td></tr>
    </table>
    <button id="EddProfile">Сохранить</button>
</div>

@section scripts
{
    <script type="text/javascript">
    $(document).ready(function () {

        GetAllProfiles();

        $("#EditProfile").click(function (event) {
            event.preventDefault();
            EditProfile();
        });

        $("#AddProfile").click(function (event) {
            event.preventDefault();
            AddProfile();
        });

    });
    // Получение всех книг по ajax-запросу
    function GetAllProfiles() {

        $("#AddBlock").css('display', 'block');
        $("#EditBlock").css('display', 'none');
        $.ajax({
            url: '/api/UserProfiles/',
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                WriteResponse(data);
            },
            error: function (x, y, z) {
                alert(x + '\n' + y + '\n' + z);
            }
        });
    }
 // Добавление новой книги
    function AddProfile() {
        // получаем значения для добавляемой книги
        var profile = {
            FirstName: $('#AddFirstName').val(),
            LastName: $('#AddLastName').val(),
            Password: $('#AddPassword').val(),
            Status: $('#AddStatus').val(),
            UserLevelID: $('#AddLevel').val(),
            LastLogin: $('#AddLastLogin').val(),
            LastUpdate: $('#AddLastUpdate').val(),
            Email: $('#AddEmail').val()
        };

        $.ajax({
            url: '/api/UserProfiles/',
            type: 'POST',
            data: JSON.stringify(profile),
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                GetAllProfiles();
            },
            error: function (x, y, z) {
                alert(x + '\n' + y + '\n' + z);
            }
        });
    }
 // Удаление книги
    function DeleteProfile(id) {

        $.ajax({
            url: '/api/UserProfiles/' + id,
            type: 'DELETE',
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                GetAllProfiles();
            },
            error: function (x, y, z) {
                alert(x + '\n' + y + '\n' + z);
            }
        });
    }
    // редактирование книги
    function EditProfile() {
        var id = $('#EditId').val()
        // получаем новые значения для редактируемой книги
        var profile = {
            Id: $('#EditId').val(),
            FirstName: $('#EditFirstName').val(),
            LastName: $('#EditLastName').val(),
            Password: $('#EditPassword').val(),
            Status: $('#EditStatus').val(),
            UserLevelID: $('#EditLevel').val(),
            LastLogin: $('#EditLastLogin').val(),
            LastUpdate: $('#EditLastUpdate').val(),
            Email: $('#EditEmail').val()
        };
        $.ajax({
            url: '/api/UserProfiles/' + id,
            type: 'PUT',
            data: JSON.stringify(profile),
            contentType: "application/json;charset=utf-8",
            success: function (data) {
                GetAllProfiles();
            },
            error: function (x, y, z) {
                alert(x + '\n' + y + '\n' + z);
            }
        });
    }
 // вывод полученных данных на экран
    function WriteResponse(profiles) {
        var strResult = "<table><th>ID</th><th>First name</th>" +
            "<th>Last name</th><th>Password</th><th>Status</th>" +
            "<th>User level</th><th>Last login</th>" +
            "<th>Last update</th><th>Email</th>";
        $.each(profiles, function (index, profile) {
            strResult += "<tr><td>" + profile.Id + "</td><td> " + profile.FirstName + "</td><td>" +
            profile.LastName + "</td><td>" + profile.Password + "</td><td>" + profile.Status +
            "</td><td>" + profile.UserLevelID + "</td><td>" + profile.LastLogin +
            "</td><td>" + profile.LastUpdate + "</td><td>" + profile.Email +
            "</td><td><a id='editItem' data-item='" + profile.Id + "' onclick='EditItem(this);' >Редактировать</a></td>" +
            "<td><a id='delItem' data-item='" + profile.Id + "' onclick='DeleteItem(this);' >Удалить</a></td></tr>";
        });
        strResult += "</table>";
        $("#TableBlock").html(strResult);

    }
    // обработчик удаления
    function DeleteItem(el) {
        // получаем id удаляемого объекта
        var id = $(el).attr('data-item');
        DeleteProfile(id);
    }
    // обработчик редактирования
    function EditItem (el) {
        // получаем id редактируемого объекта
        var id = $(el).attr('data-item');
        GetProfile(id);
    }
    // вывод данных редактируемой книги в поля для редактирования
    function ShowProfile(profile) {
        if (profile != null) {
            $("#AddBlock").css('display', 'none');
            $("#EditBlock").css('display', 'block');
            $("#EditId").val(profile.Id);
            $("#EditFirstName").val(profile.FirstName);
            $("#EditLastName").val(profile.LastName);
            $("#EditPassword").val(profile.Password);
            $("#EditStatus").val(profile.Status);
            $("#EditLevel").val(profile.UserLevelID);
            $("#EditLastLogin").val(profile.LastLogin);
            $("#EditLastUpdate").val(profile.LastUpdate);
            $("#EditEmail").val(profile.Email);
        }
        else {
            alert("There is mo such profile");
        }
    }
    // запрос книги на редактирование
    function GetProfile(id) {
        $.ajax({
            url: '/api/UserProfiles/' + id,
            type: 'GET',
            dataType: 'json',
            success: function (data) {
                ShowProfile(data);
            },
            error: function (x, y, z) {
                alert(x + '\n' + y + '\n' + z);
            }
        });
    }
    </script>
}
